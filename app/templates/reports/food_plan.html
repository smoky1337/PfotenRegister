<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Paketliste Futterausgabe</title>
  <style>
    body { font-family: sans-serif; font-size: 12px; margin: 20px; color: #222; }
    h1 { font-size: 22px; margin-bottom: 6px; }
    h2 { margin-top: 22px; font-size: 16px; }
    p { margin: 4px 0; color: #555; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #444; color: #fff; margin-right: 4px; font-size: 11px; }
    .muted { color: #777; }
    ul { padding-left: 18px; }
    .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
    .summary-item { background: #f5f5f5; padding: 10px; border-radius: 6px; }
    .card { border: 1px solid #ccc; border-radius: 6px; padding: 12px; margin-bottom: 10px; }
    @media print {
      .no-print { display: none !important; }
      body { margin: 10mm; }
    }
  </style>
</head>
<body>
  <div class="no-print" style="text-align: right; margin-bottom: 10px;">
    <button type="button" onclick="window.print()" style="padding: 6px 12px;">Drucken / Speichern</button>
  </div>

  <header style="display:flex; justify-content: space-between; align-items: center;">
    <div style="display:flex; align-items:center; gap:10px;">
      <img src="{{ settings['logourl']['value'] if settings['logourl']['value'] else url_for('static', filename='logo.png') }}" alt="Logo" style="height: 40px;">
      <div>
        <div style="font-size: 14px; color:#666;">Paketliste Futterausgabe</div>
        <h1>Plan vom {{ payload.plan_date }}</h1>
        {% if payload.location_name %}
          <div class="muted">Standort: {{ payload.location_name }}</div>
        {% elif plan.location %}
          <div class="muted">Standort: {{ plan.location.name }}</div>
        {% endif %}
      </div>
    </div>
    <div style="text-align:right;">
      <div><strong>Plan-ID:</strong> #{{ plan.id }}</div>
      <div><strong>Erstellt von:</strong> {{ plan.created_by.realname if plan.created_by else '-' }}</div>
      <div><strong>Erstellt am:</strong> {{ plan.created_on.strftime('%d.%m.%Y %H:%M') if plan.created_on else '-' }}</div>
      <div><strong>Ausgabe:</strong> {{ now.strftime('%d.%m.%Y %H:%M') }}</div>
    </div>
  </header>

  <section style="margin-top: 16px;">
    <div class="summary">
      <div class="summary-item">
        <div class="muted">Gäste</div>
        <div style="font-size:18px;">{{ summary.guests }}</div>
      </div>
      <div class="summary-item">
        <div class="muted">Tiere</div>
        <div style="font-size:18px;">{{ summary.animals }}</div>
      </div>
      <div class="summary-item">
        <div class="muted">Nach Tierart</div>
        {% if summary.species_counts %}
          {% for species, count in summary.species_counts.items() %}
            <div>{{ species }}: <strong>{{ count }}</strong></div>
          {% endfor %}
        {% else %}
          <div class="muted">Keine Auswahl</div>
        {% endif %}
      </div>
      <div class="summary-item">
        <div class="muted">Tags / Notizen</div>
        {% if summary.tag_counts %}
          {% for tag, count in summary.tag_counts.items() %}
            <div>{{ tag }}: <strong>{{ count }}</strong></div>
          {% endfor %}
        {% else %}
          <div class="muted">Keine Auswahl</div>
        {% endif %}
      </div>
    </div>
  </section>

  <section>
    <h2>Details</h2>
    {% set included_guests = payload.guests | selectattr("include") | list %}
    {% for guest in included_guests %}
      {% set included_animals = guest.animals | selectattr("include") | list %}
      {% if included_animals|length > 0 %}
        <div class="card">
          <div style="font-weight:700;">{{ guest.name }}</div>
          {% if guest.location_name %}
            <div class="muted">Standort: {{ guest.location_name }}</div>
          {% endif %}
          <ul>
            {% for animal in included_animals %}
              <li>
                <strong>{{ animal.name }}</strong> <span class="muted">({{ animal.species }})</span><br>
                {% if animal.tags %}
                  {% for tag in animal.tags %}
                    <span class="badge" style="background: {{ tag.color }}; color:#fff;">{{ tag.name }}</span>
                  {% endfor %}
                {% elif animal.notes %}
                  <span class="badge" style="background:#777; color:#fff;">{{ animal.notes }}</span>
                {% else %}
                  <span class="muted">Ohne Tag/Notiz</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endfor %}
    {% if included_guests|length == 0 %}
      <p class="muted">Keine Datensätze ausgewählt.</p>
    {% endif %}
  </section>
</body>
</html>
