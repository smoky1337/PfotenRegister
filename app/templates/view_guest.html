{% extends "base.html" %}
{% block content %}
<style>
	.formated-text {
		white-space: pre-wrap;
		!important;
		}
	</style>
<div class="container mt-4">
	<!-- Status Indicator -->
	<div class="d-flex align-items-center justify-content-center gap-3 mb-3">
		<h1 class="mb-0">Gastdetails</h1>
		<span class="badge {% if guest.status == 'Aktiv' %}bg-success{% else %}bg-danger{% endif %}">
    {{ guest.status }}
  </span>
	</div>
	{% set sorted_entries = feed_history | sort(attribute='entry_id') | sort(attribute='futtertermin') %}
	{% set latest_entry = sorted_entries | last %}
	<!-- Gast Details -->
	<div class="row g-4">
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Code</h6>
					<p class="card-text fw-bold">{{ guest.id }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Gastnummer</h6>
					<p class="card-text fw-bold">{{ guest.nummer }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Name</h6>
					<p class="card-text fw-bold">{{ guest.name }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Anschrift</h6>
					<p class="card-text fw-bold">{{ guest.anschrift }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Rufnummer</h6>
					<p class="card-text fw-bold">📱{{ guest.mobil or '-' }} | ☎️ {{ guest.festnetz or '-' }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">E-Mail</h6>
					<p class="card-text fw-bold">{{ guest.email or '-' }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Geburtsdatum</h6>
					<p class="card-text fw-bold">{{ guest.geburtsdatum.strftime('%d.%m.%Y') if guest.geburtsdatum else '-'
						}}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Geschlecht</h6>
					<p class="card-text fw-bold">{{ guest.geschlecht or '-' }}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card border border-secondary shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-subtitle" style="color: #4CAF50;">Bedürftig bis</h6>
					<p class="card-text fw-bold">{{ guest.beduerftig_bis.strftime('%d.%m.%Y') if guest.beduerftig_bis else
						'-' }}</p>
				</div>
			</div>
		</div>


		<div class="accordion">
			<div class="accordion-item">
				<h2 class="accordion-header" id="notizenHeading">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
							data-bs-target="#notizenBody" aria-expanded="true" aria-controls="notizenBody">
						Notizen
					</button>
				</h2>
				<div id="notizenBody" class="accordion-collapse collapse" aria-labelledby="notizenHeading">
					<div class="accordion-body">
						<p class="formated-text">{{ guest.notizen or '-' }}</p>
						<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
								data-bs-target="#editNotizenModal">
							✏️ Notizen bearbeiten
						</button>
					</div>

				</div>
			</div>
			{% if guest.vertreter_name %}
			<div class="accordion-item">
				<h2 class="accordion-header" id="vertreterHeading">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
							data-bs-target="#vertreterBody" aria-expanded="false" aria-controls="vertreterBody">
						Gesetzlicher Vertreter
					</button>
				</h2>
				<div id="vertreterBody" class="accordion-collapse collapse" aria-labelledby="vertreterHeading">
					<div class="accordion-body">
						<div class="row g-4">
							<div class="col-md-4">
								<div class="card border border-secondary shadow-sm mb-3">
									<div class="card-body">
										<h6 class="card-subtitle" style="color: #4CAF50;">Name</h6>
										<p class="card-text fw-bold">{{ guest.vertreter_name }}</p>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="card border border-secondary shadow-sm mb-3">
									<div class="card-body">
										<h6 class="card-subtitle" style="color: #4CAF50;">Telefon</h6>
										<p class="card-text fw-bold">{{ guest.vertreter_telefon or '-' }}</p>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="card border border-secondary shadow-sm mb-3">
									<div class="card-body">
										<h6 class="card-subtitle" style="color: #4CAF50;">Email</h6>
										<p class="card-text fw-bold">{{ guest.vertreter_email or '-' }}</p>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="card border border-secondary shadow-sm mb-3">
									<div class="card-body">
										<h6 class="card-subtitle" style="color: #4CAF50;">Adresse</h6>
										<p class="card-text fw-bold">{{ guest.vertreter_adresse or '-' }}</p>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
			{% endif %}
			{% if current_user.role in ['admin', 'editor'] %}
			<div class="accordion-item">
				<h2 class="accordion-header" id="detailsHeading">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
							data-bs-target="#detailsBody" aria-expanded="false" aria-controls="detailsBody">
						Details
					</button>
				</h2>
				<div id="detailsBody" class="accordion-collapse collapse" aria-labelledby="detailsHeading">
					<div class="accordion-body">
						<div class="mt-4">
							<div class="alert alert-info d-flex align-items-center">
								<i class="fas fa-user-shield fa-lg me-2"></i>
								<div>Diese Informationen sind nur für Administrator:innen und Bearbeiter:innen
									sichtbar.
								</div>
							</div>
							<div class="row g-4">
								<div class="col-md-4">
									<div class="card border border-secondary shadow-sm mb-3">
										<div class="card-body">
											<h6 class="card-subtitle" style="color: #4CAF50;">Aktualisiert am</h6>
											<p class="card-text fw-bold">{{ guest.aktualisiert_am.strftime('%d.%m.%Y') if
												guest.aktualisiert_am else '-' }}</p>
										</div>
									</div>
								</div>

								<div class="col-md-4">
									<div class="card border border-secondary shadow-sm mb-3">
										<div class="card-body">
											<h6 class="card-subtitle" style="color: #4CAF50;">Eintritt</h6>
											<p class="card-text fw-bold">{{ guest.eintritt.strftime('%d.%m.%Y') if
												guest.eintritt else '-' }}</p>
										</div>
									</div>
								</div>


								<div class="col-md-4">
									<div class="card border border-secondary shadow-sm mb-3">
										<div class="card-body">
											<h6 class="card-subtitle" style="color: #4CAF50;">Erstellt am</h6>
											<p class="card-text fw-bold">{{ guest.erstellt_am.strftime('%d.%m.%Y') if
												guest.erstellt_am else '-' }}</p>
										</div>
									</div>
								</div>

								<div class="col-md-6">
									<div class="card border border-secondary shadow-sm mb-3">
										<div class="card-body">
											<h6 class="card-subtitle" style="color: #4CAF50;">Bedürftigkeit</h6>
											<p class="card-text fw-bold">{{ guest.beduerftigkeit if guest.beduerftigkeit
												else '-' }}</p>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="card border border-secondary shadow-sm mb-3">
										<div class="card-body">
											<h6 class="card-subtitle" style="color: #4CAF50;">Dokumente</h6>
											<p class="card-text fw-bold">{{ guest.dokumente if guest.dokumente else '-'
												}}</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			{% endif %}

		</div>
	</div>


	<hr>

	<!-- Tierdaten -->
	<div class="d-flex align-items-center justify-content-center gap-3 mb-3" style="margin-top:2%">
		<h1 class="mb-0">Tiere - <u>Letzter Futtertermin {% if latest_entry and latest_entry.futtertermin %}
			{{ latest_entry.futtertermin.strftime('%d.%m.%Y') }}
			{% else %}
			-
			{% endif %}</u></h1>
	</div>
	<div id="tierWarningCard" class="alert alert-danger d-flex d-none align-items-center">
		<i class="far fa-calendar-times fa-lg me-2"></i>
		<div>Achtung, die Rot gerahmten Tiere wurde vor über {{ settings['maxTimeSeen']['value'] | int }} Monaten das letzte Mal vorgestellt.</div>

	</div>


	<div class="accordion mb-4" id="tierAccordion">

		{% for animal in animals %}
		<div class="accordion-item tier-card border border-secondary shadow-sm mb-3"
			 data-last-seen="{{ animal.zuletzt_gesehen.strftime('%Y-%m-%d') if animal.zuletzt_gesehen else '' }}">
			<h2 class="accordion-header" id="tierHeading{{ animal.id }}">
				<button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse"
						data-bs-target="#tierBody{{ animal.id }}" aria-expanded="false"
						aria-controls="tierBody{{ animal.id }}">
					<div class="w-100 d-flex justify-content-between align-items-center">
						<strong>{{ animal.art }} – {{ animal.name or "Unbenannt" }} – {{ animal.rasse or '-' }}</strong>
						<span class="badge bg-warning text-dark ms-3"><i class="fas fa-bone me-1"></i>{{ animal.futtermengeneintrag or '-' }}</span>
					</div>
				</button>
			</h2>
			<div id="tierBody{{ animal.id }}" class="accordion-collapse collapse"
				 aria-labelledby="tierHeading{{ animal.id }}" data-bs-parent="#tierAccordion">
				<div class="accordion-body">
					<div class="row">
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Rasse</h6>
									<p class="card-text fw-bold">{{ animal.rasse or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Geschlecht</h6>
									<p class="card-text fw-bold">{{ animal.geschlecht or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Farbe</h6>
									<p class="card-text fw-bold">{{ animal.farbe or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Kastriert</h6>
									<p class="card-text fw-bold">{{ animal.kastriert or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Chipnummer</h6>
									<p class="card-text fw-bold">{{ animal.chipnummer or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">(Geschätztes) Geburtsdatum</h6>
									<p class="card-text fw-bold">{{ animal.geburtsdatum.strftime('%d.%m.%Y') if
										animal.geburtsdatum else '-' }}</p>
								</div>
							</div>
						</div>
						<hr>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Größe/Gewicht</h6>
									<p class="card-text fw-bold">{{ animal.gewicht_oder_groesse or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Allergien</h6>
									<p class="card-text fw-bold">{{ animal.unverträglichkeiten or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Futtermitteleintrag</h6>
									<p class="card-text fw-bold">{{ animal.futtermengeneintrag or '-' }}</p>
								</div>
							</div>
						</div>
						<hr>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Vollversorgung</h6>
									<p class="card-text fw-bold">{{ animal.vollversorgung or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Krankheiten</h6>
									<p class="card-text fw-bold">{{ animal.krankheiten or '-' }}</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card border border-secondary shadow-sm mb-3">
								<div class="card-body">
									<h6 class="card-subtitle" style="color: #4CAF50;">Tierarzt</h6>
									<p class="card-text fw-bold">{{ animal.tierarzt or '-' }}</p>
								</div>
							</div>
						</div>
						<hr>
						<div class="col-mb-4">
							<div class="card border border-secondary shadow-sm md-4">
								<div class="card-body text-center">
									<h6 class="card-subtitle md-2" style="color: #4CAF50;">Zuletzt gesehen</h6>
									<p class="card-text fw-bold">
										{{ animal.zuletzt_gesehen.strftime('%d.%m.%Y') if animal.zuletzt_gesehen else '-' }}
									</p>
								</div>
							</div>
						</div>
						<div class="accordion mt-3" id="notizenAccordion{{ animal.id }}">
							<div class="accordion-item">
								<h2 class="accordion-header" id="notizenHeading{{ animal.id }}">
									<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
											data-bs-target="#notizenBody{{ animal.id }}" aria-expanded="false"
											aria-controls="notizenBody{{ animal.id }}">
										Notizen
									</button>
								</h2>
								<div id="notizenBody{{ animal.id }}" class="accordion-collapse collapse"
									 aria-labelledby="notizenHeading{{ animal.id }}"
									 data-bs-parent="#notizenAccordion{{ animal.id }}">
									<div class="accordion-body">
										<p class="formated-text">{{ animal.notizen or '-' }}</p>
										<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
												data-bs-target="#editNotizenModal{{ animal.id }}">
											✏️ Notizen bearbeiten
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				{% if current_user.role in ['admin', 'editor'] %}

				<div class="text-center mb-2 " style="margin-bottom: 1%;">
					<button class="btn btn-primary"
							onclick="window.location.href='{{ url_for('main.edit_animal', guest_id=guest.id, animal_id=animal.id) }}'">
						Tier bearbeiten
					</button>

				</div>
				{% endif %}

			</div>

		</div>

		{% endfor %}
	</div>

	<!-- Action Buttons -->
	<div class="text-center my-4">
		{% if guest.status == 'Aktiv' %}
		<button id="food-button" class="btn btn-warning">Futter verteilen</button>
		{% endif %}
		{% if current_user.role in ['admin', 'editor'] %}
		<button class="btn btn-primary"
				onclick="window.location.href='{{ url_for('main.edit_guest', guest_id=guest.id) }}'">Gast bearbeiten
		</button>
		{% endif %}
		<button class="btn btn-secondary"
				onclick="window.location.href='{{ url_for('main.print_card', guest_id=guest.id) }}'">Gästekarte
			drucken
		</button>
	</div>

	<!-- Inline Editing / Confirmation Modal for Futterausgabe -->
	<div id="foodConfirmCard" class="card border-danger mb-4 shadow-sm" style="display: none;">
		<div class="card-header bg-danger text-white">
			<h3 class="mb-0">Futterausgabe bestätigen</h3>
		</div>
		<div class="card-body">
			<!-- Warning container: shown only if last distribution is within 3 weeks -->
			<div id="warning-message" class="alert alert-warning" style="display: none;">
				<h5 class="alert-heading">Achtung: Futter wurde kürzlich verteilt</h5>
				<p>Dieser Gast hat in den letzten {{ settings['minTimeFood']['value'] | int }} Tagen bereits Futter erhalten!</p>
			</div>
			<!-- Comment field, always shown -->
			<div class="mb-3">
				<label for="futterComment" class="form-label">Kommentar zur Futterausgabe (optional):</label>
				<textarea id="futterComment" class="form-control" placeholder="Kommentar eingeben..."></textarea>
			</div>
			<div class="d-flex justify-content-center">
				<button id="confirmFoodDistribution" class="btn btn-danger me-3">Ja, fortfahren</button>
				<button id="cancelFoodDistribution" class="btn btn-secondary">Abbrechen</button>
			</div>
		</div>
	</div>
</div>

<!-- jQuery & Bootstrap -->


<hr>
<p style="text-align:center; font-style:italic;">
	Barcode eingeben oder scannen, um weitere Gäste anzuzeigen.
</p>

{% if feed_history %}
<h2>Letzte Futtertermine</h2>
<div class="table-responsive">
	<table id="futterTable" class="table table-striped table-bordered">
		<thead class="table-dark">
		<tr>
			<th>Futtertermin</th>
			<th>Notiz</th>

		</tr>
		</thead>
		<tbody>
		{% for entry in feed_history %}
		<tr>
			<td>
				{{ entry.futtertermin.strftime('%d.%m.%Y') }}
			</td>
			<td>
				{{ entry.notiz if entry.notiz else 'Keine Notiz' }}
			</td>
		</tr>
		{% endfor %}
		</tbody>
	</table>
</div>
{% else %}
<div class="alert alert-warning text-center">
	<p>Keine Futterhistorie-Einträge gefunden.</p>
</div>
{% endif %}

<!-- Änderungsprotokoll nur für Admin und Editor -->
{% if current_user.role in ['admin', 'editor'] %}
<hr>
<h2>Letzte Änderungen</h2>
{% if changelog %}
<div class="table-responsive">
	<table class="table table-striped table-bordered">
		<thead class="table-dark">
		<tr>
			<th>Datum</th>
			<th>Typ</th>
			<th>Beschreibung</th>
			<th>Bearbeitet von</th>
		</tr>
		</thead>
		<tbody>
		{% for log in changelog %}
		<tr>
			<td>{{ log.change_timestamp.strftime('%d.%m.%Y') if log.change_timestamp else '-' }}</td>
			<td>{{ log.change_type }}</td>
			<td>{{ log.description }}</td>
			<td>{{ log.changed_by }}</td>
		</tr>
		{% endfor %}
		</tbody>
	</table>
</div>
{% else %}
<div class="alert alert-secondary text-center mt-3">
	Keine Änderungen vorhanden.
</div>
{% endif %}
{% endif %}

<!-- Inline Editing Modal for Notizen -->
<div class="modal fade" id="editNotizenModal" tabindex="-1" aria-labelledby="editNotizenModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="editNotizenForm" method="post" action="{{ url_for('main.edit_notes', guest_id=guest.id) }}">
				<div class="modal-header">
					<h5 class="modal-title" id="editNotizenModalLabel">Notizen bearbeiten</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="notizenInput" class="form-label">Notizen</label>
						<textarea class="form-control" id="notizenInput" name="notizen"
								  rows="5">{{ guest.notizen }}</textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
					<button type="submit" class="btn btn-primary">Speichern</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- Modal for Tier Notizen -->
{% for animal in animals %}
<div class="modal fade" id="editNotizenModal{{ animal.id }}" tabindex="-1"
	 aria-labelledby="editNotizenModalLabel{{ animal.id }}" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post" action="{{ url_for('main.edit_animal_notes', animal_id=animal.id, guest_id=guest.id) }}">
				<div class="modal-header">
					<h5 class="modal-title" id="editNotizenModalLabel{{ animal.id }}">Notizen für {{ animal.name or 'Tier'
						}} bearbeiten</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="tierNotizenInput{{ animal.id }}" class="form-label">Notizen</label>
						<textarea class="form-control" id="tierNotizenInput{{ animal.id }}" name="notizen" rows="5">{{ animal.notizen }}</textarea>
						<input type="hidden" name="tier_id" value="{{ animal.id }}">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
					<button type="submit" class="btn btn-primary">Speichern</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}®

<script>
	$(document).ready(function () {
		$(".toggle-details").click(function (e) {
			e.preventDefault();
			var target = $(this).data("target");
			$(target).slideToggle();
			var text = $(this).text().trim() === "🔍 Mehr anzeigen" ? "🔽 Weniger anzeigen" : "🔍 Mehr anzeigen";
			$(this).text(text);
		});
	});

	$(document).ready(function () {
		$("#food-button").click(function () {
			// Get last food date from the element (assumed to be in dd.mm.yyyy format)
			var lastFoodDateText = $("#last-food-date").text().trim();
			var lastFoodDate = null;
			if (lastFoodDateText !== "-" && lastFoodDateText !== "") {
				var parts = lastFoodDateText.split(".");
				if (parts.length === 3) {
					var day = parseInt(parts[0], 10);
					var month = parseInt(parts[1], 10) - 1; // JS months are zero-based
					var year = parseInt(parts[2], 10);
					lastFoodDate = new Date(year, month, day);
				} else {
					lastFoodDate = new Date(lastFoodDateText); // fallback
				}
			}

			var now = new Date();
			var cutoff = new Date();
			cutoff.setDate(now.getDate() - {{ settings['minTimeFood']['value'] | int }});

			// Always show the modal
			$("#foodConfirmCard").slideDown();

			// If there's a last food date and it is more recent than the cutoff, show a warning
			if (lastFoodDate && lastFoodDate > cutoff) {
				$("#warning-message").show();
			} else {
				$("#warning-message").hide();
			}
		});

		$(document).ready(function () {
			var lastText = $("#futter-date-text").text().trim();
			var lastDate = null;
			if (lastText && lastText !== "-") {
				var parts = lastText.split(".");
				if (parts.length === 3) {
					var day = parseInt(parts[0], 10);
					var month = parseInt(parts[1], 10) - 1;
					var year = parseInt(parts[2], 10);
					lastDate = new Date(year, month, day);
				}
			}

			if (lastDate) {
				const now = new Date();
				const cutoff = new Date();
				cutoff.setDate(now.getDate() - {{ settings['minTimeFood']['value'] | int }});

				if (lastDate > cutoff) {
					$("#futter-card").addClass("border-warning bg-warning-subtle");
				} else {
					$("#futter-card").addClass("border-success bg-success-subtle");
				}
			}
		});

		$("#confirmFoodDistribution").click(function () {
			var comment = $("#futterComment").val().trim();
			window.location.href = "{{ url_for('main.food_dispensed', guest_id=guest.id) }}" + "?comment=" + encodeURIComponent(comment);
		});

		$("#cancelFoodDistribution").click(function () {
			$("#foodConfirmCard").slideUp();
		});
	});

	$(document).ready(function () {
		$('#futterTable').DataTable({
			"pageLength": 10,
			"order": [[2, "desc"]],
			"language": {
				"url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/German.json"
			}
		});
	});


	$(document).ready(function () {
		const today = new Date();
		const cutoff = new Date();
		cutoff.setMonth(cutoff.getMonth() -  {{ settings['maxTimeSeen']['value'] | int }});

		let outdatedTiers = [];

		$(".tier-card").each(function () {
			const $card = $(this);
			const lastSeenStr = $card.data("last-seen");

			if (lastSeenStr) {
				const lastSeen = new Date(lastSeenStr);
				if (lastSeen < cutoff) {
					$card.addClass("outline-danger");
					const name = $card.find(".card-header h4").text().trim();
					const date = new Date(lastSeen).toLocaleDateString("de-DE");
					outdatedTiers.push({name: name, date: date});
				}
			}
		});

		if (outdatedTiers.length > 0) {
			const $list = $("#outdatedTierList").empty();
			outdatedTiers.forEach(animal => {
				$list.append(`<li><strong>${animal.name}</strong> – zuletzt gesehen am ${animal.date}</li>`);
			});
			$("#tierWarningCard").removeClass("d-none");
		}
	});
</script>
<style>
	.outline-danger {
		border: 2px solid #dc3545 !important;
	}
</style>
{% endblock %}
