{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Einstellungen bearbeiten</h1>

    <ul class="nav nav-tabs mb-4" id="settingsTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link tab {% if active_tab == 'general' %}active{% endif %}" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="{{ 'true' if active_tab == 'general' else 'false' }}">
          Allgemeine Einstellungen
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link tab {% if active_tab == 'fields' %}active{% endif %}" id="fields-tab" data-bs-toggle="tab" data-bs-target="#fields" type="button" role="tab" aria-controls="fields" aria-selected="{{ 'true' if active_tab == 'fields' else 'false' }}">
          Feldsichtbarkeit
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link tab {% if active_tab == 'reminders' %}active{% endif %}" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#reminders" type="button" role="tab" aria-controls="reminders" aria-selected="{{ 'true' if active_tab == 'reminders' else 'false' }}">
          Erinnerungen
        </button>
      </li>
		<li class="nav-item" role="presentation">
			<button class="nav-link tab {% if active_tab == 'foodtags' %}active{% endif %}" id="foodtags-tab" data-bs-toggle="tab"
					data-bs-target="#foodtags" type="button" role="tab"
					aria-controls="foodtags" aria-selected="{{ 'true' if active_tab == 'foodtags' else 'false' }}">
				Foodtags
			</button>
		</li>
    </ul>

    <div class="tab-content" id="settingsTabContent">
      <div class="tab-pane fade {% if active_tab == 'general' %}show active{% endif %}" id="general" role="tabpanel" aria-labelledby="general-tab">
          <form method="post" action="{{ url_for('admin.edit_settings') }}">
              <fieldset class="border p-4 rounded shadow-sm" style="margin-bottom:3%">
                  <legend class="h5 mb-4">Allgemeine Einstellungen</legend>
                  <div class="mb-3">
                      <label for="name" class="form-label">{{settings['name']['description']}}:</label>
                      <input type="text" name="name" id="name"
                             placeholder="{{ settings['name']['value'] if settings['name']['value'] is not none else '-' }}"
                             value="{{ settings['name']['value'] if settings['name']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>

                  <div class="mb-3">
                      <label for="primarycolour" class="form-label">{{settings["primarycolour"]['description']}}:</label>
                      <input type="color" name="primarycolour" id="primarycolour"
                             placeholder="{{ settings['primarycolour']['value'] if settings['primarycolour']['value'] is not none else '-' }}"
                             value="{{ settings['primarycolour']['value'] if settings['primarycolour']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>

                  <div class="mb-3">
                      <label for="logourl" class="form-label">{{settings["logourl"]['description']}}:</label>
                      <input type="text" name="logourl" id="logourl"
                             placeholder="{{ settings['logourl']['value'] if settings['logourl']['value'] is not none else '-' }}"
                             value="{{ settings['logourl']['value'] if settings['logourl']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>

                  <div class="mb-3">
                      <label for="maxAnimals" class="form-label">{{settings["maxAnimals"]['description']}}:</label>
                      <input type="number" name="maxAnimals" id="maxAnimals"
                             placeholder="{{ settings['maxAnimals']['value'] if settings['maxAnimals']['value'] is not none else '-' }}"
                             value="{{ settings['maxAnimals']['value'] if settings['maxAnimals']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>
                  <div class="mb-3">
                      <label for="minTimeFood" class="form-label">{{settings["minTimeFood"]['description']}}:</label>
                      <input type="number" name="minTimeFood" id="minTimeFood"
                             placeholder="{{ settings['minTimeFood']['value'] if settings['minTimeFood']['value'] is not none else '-' }}"
                             value="{{ settings['minTimeFood']['value'] if settings['minTimeFood']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>
                  <div class="mb-3">
                      <label for="maxTimeSeen" class="form-label">{{settings["maxTimeSeen"]['description']}}:</label>
                      <input type="number" name="maxTimeSeen" id="maxTimeSeen"
                             placeholder="{{ settings['maxTimeSeen']['value'] if settings['maxTimeSeen']['value'] is not none else '-' }}"
                             value="{{ settings['maxTimeSeen']['value'] if settings['maxTimeSeen']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>
                  <div class="mb-3">
                      <label for="guestNumberFormat" class="form-label">{{settings["guestNumberFormat"]['description']}}:</label>
                      <input type="text" name="guestNumberFormat" id="guestNumberFormat"
                             placeholder="{{ settings['guestNumberFormat']['value'] if settings['guestNumberFormat']['value'] is not none else 'XXXXAAABBBYYYY' }}"
                             value="{{ settings['guestNumberFormat']['value'] if settings['guestNumberFormat']['value'] is not none else ''  }}"
                             class="form-control">
                      <div class="form-text">
                          Nutze am Anfang der Gästenummer Text (z.B: <code>Nummer</code>. Am Ende nutze dann mindestens drei <code>N</code> um eine aufsteigende Zahl zu haben. <br>
                          Andere Platzhalter: <br>
                          - 2 aufeinenderfolgende Y als Jahr (<code>YY</code> -> 25) oder
                          - 4 aufeinanderfolgende Y als Jahr (<code>YYYY</code> -> 2025)<br>
                          - 2 aufeinanderfolgende M als Monat (<code>MM</code> -> 06)<br><br>
                          Beispiel:<br>
                          Template <code>NummerYYYYMMNNN</code> -> Anzeige <code>Nummer202505001</code>

                      </div>
                  </div>
                  <div class="mb-3">
                      <label for="zahlungen" class="form-label">{{settings['zahlungen']['description']}}:</label>
                      <select name="zahlungen" class="form-control" id="zahlungen">
                          <option value="Aktiv" {% if settings['zahlungen']['value']== "Aktiv" %}selected{% endif %}>Aktiv</option>
                          <option value="Inaktiv" {% if settings['zahlungen']['value']== "Inaktiv" %}selected{% endif %}>Inaktiv</option>
                      </select>
				  </div>
				  <div class="mb-3">
					  <label for="tagsystem" class="form-label">{{ settings['tagsystem']['description'] }}:</label>
					  <select name="tagsystem" class="form-control" id="tagsystem">
						  <option value="Aktiv" {% if settings['tagsystem']['value']== "Aktiv" %}selected{% endif %}>
							  Aktiv
						  </option>
						  <option value="Inaktiv"
								  {% if settings['tagsystem']['value']== "Inaktiv" %}selected{% endif %}>Inaktiv
						  </option>
					  </select>
                  </div>
                  <div class="mb-3">
                    <label for="standorte" class="form-label">{{ settings['standorte']['description'] }}:</label>
                    <select name="standorte" class="form-control" id="standorte">
                        <option value="Aktiv" {% if settings['standorte']['value']== "Aktiv" %}selected{% endif %}>
                            Aktiv
                        </option>
                        <option value="Inaktiv"
                                {% if settings['standorte']['value']== "Inaktiv" %}selected{% endif %}>Inaktiv
                        </option>
                    </select>
                </div>
                  <div class="mb-3">
                      <label for="adminEmail" class="form-label">{{settings["adminEmail"]['description']}}:</label>
                      <input type="text" name="adminEmail" id="adminEmail"
                             placeholder="{{ settings['adminEmail']['value'] if settings['adminEmail']['value'] is not none else '-' }}"
                             value="{{ settings['adminEmail']['value'] if settings['adminEmail']['value'] is not none else ''  }}"
                             class="form-control">
                  </div>
              </fieldset>
              <button type="submit" class="btn btn-success">Änderungen speichern</button>
              <a href="{{ url_for('guest.index') }}" class="btn btn-secondary ms-2">Abbrechen</a>
          </form>
      </div>

      <div class="tab-pane fade {% if active_tab == 'fields' %}show active{% endif %}" id="fields" role="tabpanel" aria-labelledby="fields-tab">
          <h3>Feldsichtbarkeit anpassen</h3>
          <p>Hier kannst Du für jedes Datenmodell festlegen, welche Felder für welche Benutzerrollen sichtbar sein sollen.</p>
          <form method="post" action="{{ url_for('admin.update_field_visibility') }}">
              {% for model, fields in field_registry.items() %}
                  <fieldset class="border p-3 rounded shadow-sm mb-4">
                      <div class="row g-2 fw-bold align-items-center mb-2">
                        <div class="col-2">Sichtbar</div>
                        <div class="col-2">Sichtbar für</div>
						  <div class="col-2">Editierbar für</div>
                        <div class="col-3">UI-Label</div>
						  <div class="col-1">Inline anzeigen</div>
						  <div class="col-2">Reihenfolge</div>
                      </div>
                      <legend>{{ model }}</legend>
                      {% for field in fields %}
                          <div class="row g-2 align-items-center mb-2" style="border-bottom: black 1px dashed">
                            <div class="col-2">
                              <input class="form-check-input me-2" type="checkbox"
                                     name="visible_fields"
                                     value="{{ field.id }}"
                                     id="field_{{ field.id }}"
                                     {% if field.globally_visible %}checked{% endif %}>
                              <label class="form-check-label" for="field_{{ field.id }}">
                                  {{ field.field_name }}
                              </label>
                            </div>
                            <div class="col-2">
                              <select name="visibility_level_{{ field.id }}" class="form-select form-select-sm">
                                <option value="User" {% if field.visibility_level == "User" %}selected{% endif %}>User</option>
                                <option value="Editor" {% if field.visibility_level == "Editor" %}selected{% endif %}>Editor</option>
                                <option value="Admin" {% if field.visibility_level == "Admin" %}selected{% endif %}>Admin</option>
                              </select>
							</div>
							  <div class="col-2">
								  <select name="editability_level_{{ field.id }}" class="form-select form-select-sm">
									  <option value="User"
											  {% if field.editability_level == "User" %}selected{% endif %}>User
									  </option>
									  <option value="Editor"
											  {% if field.editability_level == "Editor" %}selected{% endif %}>Editor
									  </option>
									  <option value="Admin"
											  {% if field.editability_level == "Admin" %}selected{% endif %}>Admin
									  </option>
								  </select>
                            </div>
                            <div class="col-3">
                              <input type="text" name="ui_label_{{ field.id }}" class="form-control form-control-sm"
                                     placeholder="Anzeigename"
                                     value="{{ field.ui_label }}">
                              <label class="form-label" for="ui_label_{{ field.id }}">UI-Label</label>
                            </div>
							  <div class="col-1 form-check">
                              <input type="checkbox" class="form-check-input"
                                     name="show_inline_{{ field.id }}"
                                     id="show_inline_{{ field.id }}"
                                     {% if field.show_inline %}checked{% endif %}>
                              <label class="form-check-label" for="show_inline_{{ field.id }}">Inline</label>
                            </div>
							  <div class="col-2">
                              <input type="number" min="0" name="display_order_{{ field.id }}" class="form-control form-control-sm"
                                     value="{{ field.display_order }}">
                              <label class="form-label" for="display_order_{{ field.id }}">Reihenfolge</label>
                            </div>
                          </div>
                      {% endfor %}
                  </fieldset>
              {% endfor %}
              <button type="submit" class="btn btn-primary">Feldsichtbarkeit speichern</button>
          </form>
      </div>
      <div class="tab-pane fade {% if active_tab == 'reminders' %}show active{% endif %}" id="reminders" role="tabpanel" aria-labelledby="reminders-tab">
		  <h3>Erinnerungs-Einstellungen</h3>
		  <p class="text-muted">
			  Nur Felder mit Datumsangaben können für Erinnerungen genutzt werden. Bitte gib an,
			  wann die nächste Prüfung erfolgen soll.
		  </p>
		  <form method="post" action="{{ url_for('admin.reminder_settings') }}">
			  {% if reminder_fields %}
				  {% for model, fields in reminder_fields.items() %}
					  <div class="card shadow-sm mb-4">
						  <div class="card-header fw-bold bg-light">{{ model }}</div>
						  <div class="card-body p-0">
							  <table class="table mb-0">
								  <thead class="table-light">
								  <tr>
									  <th style="width:25%">Feld</th>
									  <th style="width:20%">Erinnerung aktiv</th>
									  <th style="width:35%">Prüfintervall (Tage)</th>
									  <th style="width:20%">Anzeigename</th>
								  </tr>
								  </thead>
								  <tbody>
								  {% for field in fields %}
									  <tr>
										  <td>
											  <div class="fw-semibold">{{ field.field_name }}</div>
											  <small class="text-muted">aktuell angezeigt als "{{ field.ui_label }}"</small>
										  </td>
										  <td>
											  <div class="form-check form-switch">
												  <input type="checkbox"
														 class="form-check-input reminder-toggle"
														 id="remindable_{{ field.id }}"
														 name="remindable_{{ field.id }}"
														 data-target="interval_{{ field.id }}"
														 {% if field.remindable %}checked{% endif %}>
												  <label class="form-check-label" for="remindable_{{ field.id }}">Aktiv</label>
											  </div>
										  </td>
										  <td>
											  <input type="number"
													 min="0"
													 class="form-control"
													 id="interval_{{ field.id }}"
													 name="reminder_interval_{{ field.id }}"
													 placeholder="z.B. 365"
													 value="{{ field.reminder_interval_days if field.reminder_interval_days is not none else '' }}"
													 {% if not field.remindable %}disabled{% endif %}>
											  <small class="text-muted">0 Tage = Warnung sobald Datum überschritten.</small>
											  {% if field.model_name == 'Animal' and animal_species %}
												  <div class="mt-2">
													  <small class="text-muted">Relevante Arten auswählen:</small>
													  <div class="d-flex flex-wrap gap-2">
														  {% set selected = field.selected_species or [] %}
														  {% for specie in animal_species %}
															  <div class="form-check form-check-inline">
																  <input class="form-check-input"
																		 type="checkbox"
																		 id="specie_{{ field.id }}_{{ loop.index }}"
																		 name="reminder_species_{{ field.id }}"
																		 value="{{ specie }}"
																		 {% if specie in selected %}checked{% endif %}>
																  <label class="form-check-label" for="specie_{{ field.id }}_{{ loop.index }}">
																	  {{ specie }}
																  </label>
															  </div>
														  {% endfor %}
													  </div>
													  <small class="text-muted d-block">Keine Auswahl = alle Arten.</small>
												  </div>
											  {% endif %}
										  </td>
										  <td>{{ field.ui_label }}</td>
									  </tr>
								  {% endfor %}
								  </tbody>
							  </table>
						  </div>
					  </div>
				  {% endfor %}
			  {% else %}
				  <div class="alert alert-info">Keine passenden Felder vorhanden.</div>
			  {% endif %}
			  <div class="d-flex justify-content-end gap-2">
				  <button type="submit" class="btn btn-success">
					  <i class="fa-solid fa-floppy-disk me-1"></i> Speichern
				  </button>
			  </div>
		  </form>
      </div>
      {% if settings['tagsystem']['value']== "Aktiv" %}
		<div class="tab-pane fade {% if active_tab == 'foodtags' %}show active{% endif %}" id="foodtags" role="tabpanel" aria-labelledby="foodtags-tab">
			<h3>Foodtags verwalten</h3>
			<form method="post" action="{{ url_for('admin.update_foodtags') }}">
				<table class="table table-striped">
					<thead>
					<tr>
						<th>Name</th>
						<th>Farbe</th>
						<th>-</th>
					</tr>
					</thead>
					<tbody>
					{% for tag in foodtags %}
						<tr>
							<td>
								<input type="text" name="name_{{ tag.id }}" value="{{ tag.name }}"
									   class="form-control form-control-sm">
							</td>
							<td>
								<input type="color" name="color_{{ tag.id }}" value="{{ tag.color }}"
									   class="form-control form-control-color">
							</td>
							<td class="text-center">
								<input type="hidden" name="delete_{{ tag.id }}" id="delete_input_{{ tag.id }}"
									   value="0">
								<button type="button"
										class="btn btn-sm btn-outline-danger delete-foodtag"
										data-id="{{ tag.id }}">
									<i class="fa-solid fa-trash"></i>
								</button>
							</td>
						</tr>
					{% endfor %}
					<!-- Template for new tag rows (hidden) -->
					<tr id="foodtag-template-row" hidden style="background-color:lightgreen">
						<td>
							<input type="text" name="new_name[]" placeholder="Neuer Tag"
								   class="form-control form-control-sm">
						</td>
						<td>
							<input type="color" name="new_color[]" value="#000000"
								   class="form-control form-control-color">
						</td>
						<td class="text-center">
							<button type="button"
									class="btn btn-sm btn-outline-danger remove-foodtag-row">
								<i class="fa-solid fa-trash"></i>
							</button>
						</td>
					</tr>
					</tbody>
				</table>
				<div class="mb-3">
					<button type="button" id="add-foodtag-btn" class="btn btn-sm btn-outline-success">
						<i class="fa-solid fa-plus"></i> Neuen Tag hinzufügen
					</button>
				</div>
				<button type="submit" class="btn btn-primary">Änderungen speichern</button>
			</form>
		</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
	<script>
        $(document).ready(function () {
            var $tbody = $('#foodtags tbody');

            // Add new tag row
            $('#add-foodtag-btn').on('click', function () {
                var $template = $('#foodtag-template-row');
                var $new = $template.clone().removeAttr('id').removeAttr('hidden');
                $tbody.append($new);
            });

            // Remove a newly added row
            $tbody.on('click', '.remove-foodtag-row', function () {
                $(this).closest('tr').remove();
            });

            // Mark existing tag for deletion and hide row
            $tbody.on('click', '.delete-foodtag', function () {
                var id = $(this).data('id');
                $('#delete_input_' + id).val('1');
                $(this).closest('tr').hide();
            });

            // Validate unique tag names before submitting
            $('form[action="{{ url_for('admin.update_foodtags') }}"]').on('submit', function (e) {
                var names = [];
                // Collect existing tag names
                $('input[name^="name_"]').each(function () {
                    var val = $(this).val().trim();
                    if (val) names.push(val);
                });
                // Collect new tag names
                $('input[name="new_name[]"]').each(function () {
                    var val = $(this).val().trim();
                    if (val) names.push(val);
                });
                // Check for duplicates
                var seen = {};
                var duplicates = [];
                names.forEach(function (n) {
                    if (seen[n]) {
                        if (!duplicates.includes(n)) duplicates.push(n);
                    } else {
                        seen[n] = true;
                    }
                });
                if (duplicates.length > 0) {
                    alert("Die folgenden Tag-Namen sind doppelt: " + duplicates.join(", ") + ". Bitte verwende eindeutige Namen.");
                    e.preventDefault();
                }
            });

            $('.reminder-toggle').on('change', function () {
                var targetId = $(this).data('target');
                var $target = $('#' + targetId);
                if ($(this).is(':checked')) {
                    $target.prop('disabled', false);
                } else {
                    $target.prop('disabled', true).val('');
                }
            });
        });
	</script>
{% endblock %}
