{% extends "base.html" %}
{% block styles %}
  {{ super() }}
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
{% endblock %}
{% block content %}
<div class="container mt-4">
  {% set emails_enabled = settings.get('emailEnabled', {}).get('value') == 'Aktiv' %}
  <h1>Gästekarten erstellen</h1>
  <div class="accordion" id="guestCardAccordion">
    <!-- Print cards -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPrint">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrint" aria-expanded="true" aria-controls="collapsePrint">
          Gästekarten drucken
        </button>
      </h2>
      <div id="collapsePrint" class="accordion-collapse collapse show" aria-labelledby="headingPrint" data-bs-parent="#guestCardAccordion">
        <div class="accordion-body">
          <p>Wähle die Gäste aus, für die Du eine Gästekarte drucken möchtest.</p>
          <p>Ausgewählt: <span id="selectedCountPrint">0</span></p>
          <form id="printForm" method="post" action="{{ url_for('admin.print_guest_cards') }}">
            <table id="printGuestTable" class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th scope="col"><input type="checkbox" id="selectAllPrint"></th>
                  <th scope="col">Gastnummer</th>
                  <th scope="col">Nachname</th>
                  <th scope="col">Vorname</th>
                  <th scope="col">Karte gedruckt?</th>
                  <th scope="col">Karte gemailt?</th>
                </tr>
              </thead>
              <tbody>
                {% for guest in guests %}
                <tr>
                  <td>
                    <input type="checkbox"
                           name="guest_ids"
                           value="{{ guest.id }}"
                           class="select-guest-print">
                  </td>
                  <td>{{ guest.number }}</td>
                  <td>{{ guest.lastname }}</td>
                  <td>{{ guest.firstname }}</td>
                  <td>
                    {% if guest.guest_card_printed_on %}
                      {{ guest.guest_card_printed_on.strftime('%d.%m.%Y') }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if guest.guest_card_emailed_on %}
                      {{ guest.guest_card_emailed_on.strftime('%d.%m.%Y') }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="backside" name="backside" checked>
              <label class="form-check-label" for="backside">Mit Rückseite?</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="flip_backside" name="flip_backside" value="1">
              <label class="form-check-label" for="flip_backside">Duplex: Rückseite spiegeln (wenn Vorder-/Rückseite nicht deckungsgleich)</label>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button type="submit" name="action" value="print" class="btn btn-primary">
                Gästekarten drucken (PDF)
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Email cards -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingEmail">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmail" aria-expanded="false" aria-controls="collapseEmail">
          Gästekarten per E-Mail senden
        </button>
      </h2>
      <div id="collapseEmail" class="accordion-collapse collapse" aria-labelledby="headingEmail" data-bs-parent="#guestCardAccordion">
	        <div class="accordion-body">
	          {% if not emails_enabled %}
	            <div class="alert alert-secondary" role="alert">
	              E-Mail Versand ist deaktiviert.
	            </div>
	          {% endif %}
	          <p>Nur Gäste mit hinterlegter E-Mail-Adresse werden angezeigt.</p>
	          <p>Ausgewählt: <span id="selectedCountEmail">0</span></p>
	          <form id="emailForm" method="post" action="{{ url_for('admin.print_guest_cards') }}">
	            <table id="emailGuestTable" class="table table-striped table-bordered">
	              <thead>
	                <tr>
	                  <th scope="col"><input type="checkbox" id="selectAllEmail" {% if not emails_enabled %}disabled{% endif %}></th>
	                  <th scope="col">Gastnummer</th>
	                  <th scope="col">Nachname</th>
	                  <th scope="col">Vorname</th>
	                  <th scope="col">E-Mail</th>
	                  <th scope="col">Karte gemailt?</th>
                </tr>
              </thead>
              <tbody>
                {% set email_guests = guests | selectattr('email') | list %}
                {% if email_guests %}
                  {% for guest in email_guests %}
	                  <tr>
	                    <td>
	                      <input type="checkbox"
	                             name="guest_ids"
	                             value="{{ guest.id }}"
	                             class="select-guest-email"
	                             {% if not emails_enabled %}disabled{% endif %}>
	                    </td>
                    <td>{{ guest.number }}</td>
                    <td>{{ guest.lastname }}</td>
                    <td>{{ guest.firstname }}</td>
                    <td>{{ guest.email or '-' }}</td>
                    <td>
                      {% if guest.guest_card_emailed_on %}
                        {{ guest.guest_card_emailed_on.strftime('%d.%m.%Y') }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-center text-muted">Keine Gäste mit E-Mail-Adresse vorhanden.</td>
                  </tr>
                {% endif %}
              </tbody>
	            </table>
	            <div class="d-flex gap-2 mt-2">
	              <button type="submit" name="action" value="email" class="btn btn-outline-primary" {% if not emails_enabled %}disabled{% endif %}>
	                Gästekarten per E-Mail senden
	              </button>
	            </div>
	          </form>
	        </div>
	      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    $(document).ready(function() {
      function setupSelectableTable(opts) {
        var selected = new Set();
        var table = $(opts.tableSelector).DataTable({
          columnDefs: [{ orderable: false, targets: 0 }],
          order: [[1, "asc"]],
          lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Alle"]],
          language: {
            url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/German.json"
          }
        });

        function updateCount() {
          $(opts.countSelector).text(selected.size);
        }
        updateCount();

        $(opts.tableSelector + ' tbody').on('change', opts.checkboxSelector, function() {
          var id = $(this).val();
          if (this.checked) {
            selected.add(id);
          } else {
            selected.delete(id);
          }
          updateCount();
        });

        table.on('draw', function() {
          var rows = table.rows({ page: 'current' }).nodes();
          $(opts.checkboxSelector, rows).each(function() {
            $(this).prop('checked', selected.has($(this).val()));
          });
          var allVisible = $(opts.checkboxSelector, rows).length > 0;
          var allChecked = allVisible && $(opts.checkboxSelector, rows).length === $(opts.checkboxSelector + ':checked', rows).length;
          $(opts.selectAllSelector).prop('checked', allChecked);
          updateCount();
        });

        $(opts.selectAllSelector).on('change', function() {
          var rows = table.rows({ page: 'current' }).nodes();
          $(opts.checkboxSelector, rows).each(function() {
            var id = $(this).val();
            if ($(opts.selectAllSelector).prop('checked')) {
              selected.add(id);
              $(this).prop('checked', true);
            } else {
              selected.delete(id);
              $(this).prop('checked', false);
            }
          });
          updateCount();
        });

        $(opts.formSelector).on('submit', function() {
          // Remove old dynamic inputs
          $(opts.formSelector + ' input[name="guest_ids"][data-dynamic="1"]').remove();
          selected.forEach(function(id) {
            $('<input>').attr({
              type: 'hidden',
              name: 'guest_ids',
              value: id,
              'data-dynamic': '1'
            }).appendTo(opts.formSelector);
          });
        });
      }

      setupSelectableTable({
        tableSelector: '#printGuestTable',
        checkboxSelector: 'input.select-guest-print',
        selectAllSelector: '#selectAllPrint',
        countSelector: '#selectedCountPrint',
        formSelector: '#printForm'
      });

      setupSelectableTable({
        tableSelector: '#emailGuestTable',
        checkboxSelector: 'input.select-guest-email',
        selectAllSelector: '#selectAllEmail',
        countSelector: '#selectedCountEmail',
        formSelector: '#emailForm'
      });
    });
  </script>
{% endblock %}
